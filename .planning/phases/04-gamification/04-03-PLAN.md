---
phase: 04-gamification
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [web/index.html]
autonomous: false

must_haves:
  truths:
    - "User sees topic mastery progress bars"
    - "Weak topics (< 70%) are highlighted in red/orange"
    - "User can view stats dashboard with overall metrics"
    - "Per-question tracking records correct/incorrect history"
    - "Quiz history shows past attempts over time"
  artifacts:
    - path: "web/index.html"
      provides: "Progress tracking and stats dashboard"
      contains: "topicStats"
  key_links:
    - from: "selectAnswer()"
      to: "updateTopicStats()"
      via: "function call on answer"
      pattern: "updateTopicStats\\("
    - from: "stats screen"
      to: "topic progress bars"
      via: "DOM rendering"
      pattern: "topic-progress"
---

<objective>
Build progress tracking with topic mastery visualization and a stats dashboard.

Purpose: Help users understand their performance across topics, identify weak areas, and track improvement over time.

Output: Updated web/index.html with per-topic progress bars, weak topic highlighting, and a stats dashboard showing overall metrics.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gamification/04-CONTEXT.md
@.planning/phases/04-gamification/04-01-SUMMARY.md

Key decisions from CONTEXT.md:
- Topic mastery: Progress bars per topic (no percentages shown)
- Weak topic highlighting: Red/orange color for < 70%
- Stats dashboard: Total questions, accuracy %, time studied
- Time range: All-time stats only (lifetime)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement per-topic tracking data model</name>
  <files>web/index.html</files>
  <action>
Add topic-level tracking to the gamification state:

1. Extend gamificationState with topic tracking:
```javascript
// Add to gamificationState:
topicStats: {},  // { topicName: { correct: N, total: N } }
```

2. Create updateTopicStats(question, isCorrect) function:
```javascript
function updateTopicStats(question, isCorrect) {
  const topic = question.topic;

  if (!gamificationState.topicStats[topic]) {
    gamificationState.topicStats[topic] = { correct: 0, total: 0 };
  }

  gamificationState.topicStats[topic].total++;
  if (isCorrect) {
    gamificationState.topicStats[topic].correct++;
  }

  saveGamificationState();
}
```

3. Create getTopicMastery() helper:
```javascript
function getTopicMastery(topic) {
  const stats = gamificationState.topicStats[topic];
  if (!stats || stats.total === 0) return 0;
  return (stats.correct / stats.total) * 100;
}

function getAllTopicStats() {
  const topics = [...new Set(questions.map(q => q.topic))];
  return topics.map(topic => {
    const stats = gamificationState.topicStats[topic] || { correct: 0, total: 0 };
    const mastery = stats.total > 0 ? (stats.correct / stats.total) * 100 : 0;
    const isWeak = stats.total > 0 && mastery < 70;
    return {
      topic,
      correct: stats.correct,
      total: stats.total,
      mastery,
      isWeak,
      questionCount: questions.filter(q => q.topic === topic).length
    };
  }).sort((a, b) => a.topic.localeCompare(b.topic));
}
```

4. Call updateTopicStats() in selectAnswer() after recording the answer:
```javascript
// In selectAnswer(), after questionResults[question.id] = {...}
updateTopicStats(question, isCorrect);
```

5. Update loadGamificationState() to initialize topicStats if missing
  </action>
  <verify>
Console check:
- Answer questions from different topics
- `gamificationState.topicStats` should show per-topic correct/total
- `getTopicMastery('DNA Structure')` should return 0-100
- `getAllTopicStats()` should return array with all topics
  </verify>
  <done>
Topic performance tracked per-question, accessible via helper functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Build stats dashboard with topic progress bars</name>
  <files>web/index.html</files>
  <action>
Add a stats dashboard screen with topic mastery visualization:

1. Add CSS for stats screen:
```css
.stats-screen {
  display: none;
}

.stats-screen.show {
  display: block;
  animation: fadeIn 0.3s ease;
}

.stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
}

.stats-title {
  color: #667eea;
  font-size: 28px;
  font-weight: 700;
}

.stats-overview {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}

.stat-card {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.stat-card-value {
  font-size: 36px;
  font-weight: 700;
  color: #667eea;
}

.stat-card-label {
  font-size: 13px;
  color: #64748b;
  margin-top: 4px;
}

.topics-section {
  margin-top: 24px;
}

.topics-section-title {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 16px;
}

.topic-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.topic-item {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 16px;
}

.topic-item.weak {
  border-color: #f97316;
  background: #fffbeb;
}

.topic-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.topic-name {
  font-weight: 600;
  color: #1f2937;
  font-size: 14px;
}

.topic-item.weak .topic-name {
  color: #c2410c;
}

.topic-stats-text {
  font-size: 12px;
  color: #64748b;
}

.topic-item.weak .topic-stats-text {
  color: #ea580c;
}

.topic-progress-bar {
  height: 10px;
  background: #e2e8f0;
  border-radius: 5px;
  overflow: hidden;
}

.topic-progress-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.5s ease;
}

.topic-progress-fill.excellent {
  background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
}

.topic-progress-fill.good {
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.topic-progress-fill.weak {
  background: linear-gradient(90deg, #f97316 0%, #ea580c 100%);
}

.topic-progress-fill.none {
  background: #94a3b8;
}

.weak-warning {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 11px;
  color: #c2410c;
  margin-top: 8px;
}

.history-section {
  margin-top: 32px;
  padding-top: 24px;
  border-top: 1px solid #e2e8f0;
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.history-item {
  display: flex;
  justify-content: space-between;
  padding: 12px 16px;
  background: #f8fafc;
  border-radius: 8px;
}

.history-date {
  color: #64748b;
  font-size: 13px;
}

.history-score {
  font-weight: 600;
}

.history-score.high {
  color: #22c55e;
}

.history-score.medium {
  color: #667eea;
}

.history-score.low {
  color: #ef4444;
}

@media (max-width: 640px) {
  .stats-overview {
    grid-template-columns: 1fr;
    gap: 12px;
  }

  .stat-card {
    padding: 16px;
  }

  .stat-card-value {
    font-size: 28px;
  }

  .topic-item {
    padding: 12px;
  }
}
```

2. Add stats screen HTML (inside container, after achievements-screen):
```html
<div id="stats-screen" class="stats-screen">
  <div class="stats-header">
    <h2 class="stats-title">Your Progress</h2>
    <button class="back-btn" onclick="hideStats()">‚Üê Back to Quiz</button>
  </div>

  <div class="stats-overview">
    <div class="stat-card">
      <div class="stat-card-value" id="stats-total-questions">0</div>
      <div class="stat-card-label">Questions Answered</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value" id="stats-accuracy">0%</div>
      <div class="stat-card-label">Overall Accuracy</div>
    </div>
    <div class="stat-card">
      <div class="stat-card-value" id="stats-quizzes">0</div>
      <div class="stat-card-label">Quizzes Completed</div>
    </div>
  </div>

  <div class="topics-section">
    <div class="topics-section-title">Topic Mastery</div>
    <div class="topic-list" id="topic-list"></div>
  </div>

  <div class="history-section">
    <div class="topics-section-title">Quiz History</div>
    <div class="history-list" id="stats-history-list"></div>
  </div>
</div>
```

3. Add button to view stats (next to achievements button in gamification-bar):
```html
<button class="view-stats-btn" onclick="showStats()" title="View Progress">üìä</button>
```

Add CSS:
```css
.view-stats-btn {
  background: none;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
  margin-left: 6px;
}

.view-stats-btn:hover {
  background: #f1f5f9;
  border-color: #667eea;
}
```

4. Add JavaScript for stats screen:
```javascript
function showStats() {
  document.getElementById('quiz-area').style.display = 'none';
  document.getElementById('final-score').classList.remove('show');
  document.getElementById('achievements-screen').classList.remove('show');
  document.getElementById('stats-screen').classList.add('show');
  renderStats();
}

function hideStats() {
  document.getElementById('stats-screen').classList.remove('show');
  document.getElementById('quiz-area').style.display = 'block';
}

function renderStats() {
  // Calculate overall stats
  const topicStats = getAllTopicStats();
  let totalCorrect = 0;
  let totalAnswered = 0;

  topicStats.forEach(ts => {
    totalCorrect += ts.correct;
    totalAnswered += ts.total;
  });

  const accuracy = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;

  // Update overview cards
  document.getElementById('stats-total-questions').textContent = gamificationState.totalQuestionsAnswered || 0;
  document.getElementById('stats-accuracy').textContent = accuracy + '%';
  document.getElementById('stats-quizzes').textContent = gamificationState.quizzesCompleted || 0;

  // Render topic progress bars
  const topicList = document.getElementById('topic-list');
  topicList.innerHTML = topicStats.map(ts => renderTopicItem(ts)).join('');

  // Render history
  const history = getQuizHistory();
  const historyList = document.getElementById('stats-history-list');

  if (history.length === 0) {
    historyList.innerHTML = '<div style="color: #94a3b8; text-align: center; padding: 20px;">No quiz history yet</div>';
  } else {
    historyList.innerHTML = history.slice(0, 10).map(h => renderHistoryItem(h)).join('');
  }
}

function renderTopicItem(ts) {
  const progressClass = ts.total === 0 ? 'none' :
                        ts.mastery >= 90 ? 'excellent' :
                        ts.mastery >= 70 ? 'good' : 'weak';

  return `
    <div class="topic-item ${ts.isWeak ? 'weak' : ''}">
      <div class="topic-item-header">
        <div class="topic-name">${ts.topic}</div>
        <div class="topic-stats-text">${ts.correct}/${ts.total} correct</div>
      </div>
      <div class="topic-progress-bar">
        <div class="topic-progress-fill ${progressClass}" style="width: ${ts.mastery}%"></div>
      </div>
      ${ts.isWeak ? '<div class="weak-warning">‚ö†Ô∏è Needs review</div>' : ''}
    </div>
  `;
}

function renderHistoryItem(h) {
  const date = new Date(h.date);
  const dateStr = date.toLocaleDateString();
  const scoreClass = h.percentage >= 80 ? 'high' : h.percentage >= 60 ? 'medium' : 'low';

  return `
    <div class="history-item">
      <div class="history-date">${dateStr}</div>
      <div class="history-score ${scoreClass}">${h.score}/${h.total} (${h.percentage}%)</div>
    </div>
  `;
}
```
  </action>
  <verify>
1. Click üìä button: stats screen appears
2. Overview shows total questions, accuracy %, quizzes completed
3. Topic list shows all topics with progress bars
4. Topics with < 70% mastery show orange border and "Needs review" warning
5. History section shows past quiz attempts
6. "Back to Quiz" returns to quiz
7. Mobile: stat cards stack vertically
  </verify>
  <done>
Stats dashboard shows overall metrics, topic progress bars, and quiz history
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete gamification system with XP/levels, achievements, and progress tracking</what-built>
  <how-to-verify>
1. Open web/index.html in browser
2. Verify gamification bar at top shows Level, XP progress, and daily streak
3. Answer questions:
   - Correct answers award XP (10 base + streak bonus)
   - XP bar fills, level increases at 100 XP
   - Streak counter shows "Streak x2!" etc. on consecutive correct
4. Check achievements (üèÖ button):
   - Milestone and topic badges visible
   - Unlocked badges have colored border
   - Locked badges show requirements
5. Check progress (üìä button):
   - Overview cards show accurate stats
   - Topic progress bars fill based on performance
   - Weak topics (< 70%) highlighted in orange
   - Quiz history shows past attempts
6. Complete a full quiz:
   - Toast notification appears for achievements
   - Toasts auto-dismiss after ~4 seconds
7. Refresh page:
   - All data persists (XP, achievements, topic stats)
8. Test on mobile viewport:
   - Gamification bar stacks properly
   - Achievement/stats grids adjust
   - Toasts position correctly
  </how-to-verify>
  <resume-signal>Type "approved" if gamification works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Open web/index.html in browser
2. Gamification bar shows at top with level, XP, streak
3. Stats screen (üìä) shows:
   - Total questions answered
   - Overall accuracy percentage
   - Quizzes completed count
   - Topic progress bars for all topics
   - Weak topics highlighted in orange with warning
   - Quiz history with past attempts
4. Topic progress updates after answering questions from that topic
5. Weak topics (< 70%) clearly indicated
6. All stats persist after page refresh
7. Mobile layout works for stats screen
</verification>

<success_criteria>
- Per-topic tracking accurate (correct/total per topic)
- Progress bars reflect actual mastery
- Weak topics (< 70%) highlighted with orange styling
- Stats dashboard shows all key metrics
- Quiz history displays chronologically
- All data persists in localStorage
- Mobile-responsive design
</success_criteria>

<output>
After completion, create `.planning/phases/04-gamification/04-03-SUMMARY.md`
</output>
