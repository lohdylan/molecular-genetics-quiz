---
phase: 04-gamification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [web/index.html]
autonomous: true

must_haves:
  truths:
    - "User earns 10 XP for each correct answer"
    - "User earns bonus XP for consecutive correct answers (streak bonus)"
    - "User sees current level and XP progress in top bar during quiz"
    - "User sees daily streak counter with fire icon"
    - "Daily streak increments when user answers 10+ questions in a day"
    - "XP and streak data persist across sessions"
  artifacts:
    - path: "web/index.html"
      provides: "Gamification core system with XP, levels, streaks"
      contains: "gamificationState"
  key_links:
    - from: "selectAnswer()"
      to: "awardXP()"
      via: "function call after correct answer"
      pattern: "awardXP\\("
    - from: "gamificationState"
      to: "localStorage"
      via: "saveGamificationState/loadGamificationState"
      pattern: "localStorage.*gamificationState"
---

<objective>
Build the core XP, leveling, and daily streak system for quiz gamification.

Purpose: Create the foundational gamification mechanics that reward correct answers with XP, track progression through levels, and encourage daily engagement through streak tracking.

Output: Updated web/index.html with XP/level/streak display in top bar, XP awarding logic, level progression, and persistent daily streaks.
</objective>

<execution_context>
@C:\Users\dylan\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dylan\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gamification/04-CONTEXT.md

Key decisions from CONTEXT.md:
- +10 XP base per correct answer
- Streak bonus: +5 XP per consecutive correct (3-streak = +15 bonus)
- 100 XP per level (Level 1 = 100 XP, Level 10 = 1000 XP total)
- Daily streak: 10 questions minimum, midnight local time reset
- Fire icon for streak display (Duolingo-style)
- Top bar always visible during quiz
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gamification data model and localStorage persistence</name>
  <files>web/index.html</files>
  <action>
Add gamification state management to the JavaScript section:

1. Create gamificationState object:
```javascript
let gamificationState = {
  totalXP: 0,
  currentStreak: 0,       // consecutive correct in current session
  dailyStreak: 0,         // days studied in a row
  lastStudyDate: null,    // ISO date string (YYYY-MM-DD)
  questionsToday: 0,      // questions answered today
  todayDate: null         // current date for reset detection
};
```

2. Add saveGamificationState() function:
- Stringify gamificationState to localStorage key 'gamificationData'
- Include try/catch for storage errors

3. Add loadGamificationState() function:
- Load from localStorage 'gamificationData'
- Parse JSON, validate structure
- Check if todayDate matches current date:
  - If different day: check if previous day had 10+ questions
    - Yes: increment dailyStreak
    - No: reset dailyStreak to 0
  - Reset questionsToday to 0, update todayDate
- Return true if loaded successfully, false to start fresh
- Graceful fallback to default state on error

4. Add helper functions:
- getCurrentDateString(): returns YYYY-MM-DD in local timezone
- calculateLevel(xp): returns Math.floor(xp / 100) + 1
- getXPForNextLevel(xp): returns 100 - (xp % 100)

5. Call loadGamificationState() in initQuiz() before displayQuestion()
  </action>
  <verify>
Open browser console, type:
- `gamificationState` should show the object
- `calculateLevel(250)` should return 3
- `getXPForNextLevel(250)` should return 50
- After answering a question and refreshing, gamificationState should persist
  </verify>
  <done>
Gamification state persists in localStorage with daily streak logic working correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement XP awarding with streak bonuses</name>
  <files>web/index.html</files>
  <action>
Add XP logic to the existing selectAnswer() function:

1. Create awardXP(isCorrect) function:
```javascript
function awardXP(isCorrect) {
  if (isCorrect) {
    // Base XP
    let xpEarned = 10;

    // Increment answer streak
    gamificationState.currentStreak++;

    // Streak bonus: +5 per consecutive correct answer
    // 1st correct: 10 XP (no bonus)
    // 2nd correct: 10 + 5 = 15 XP
    // 3rd correct: 10 + 10 = 20 XP
    if (gamificationState.currentStreak > 1) {
      xpEarned += (gamificationState.currentStreak - 1) * 5;
    }

    gamificationState.totalXP += xpEarned;
    gamificationState.questionsToday++;

    // Check if daily streak should be maintained (10+ questions)
    // This is checked on next day load, but update lastStudyDate
    gamificationState.lastStudyDate = getCurrentDateString();

    saveGamificationState();
    updateGamificationUI();

    return xpEarned;
  } else {
    // Reset answer streak on incorrect
    gamificationState.currentStreak = 0;
    gamificationState.questionsToday++;
    gamificationState.lastStudyDate = getCurrentDateString();
    saveGamificationState();
    updateGamificationUI();
    return 0;
  }
}
```

2. In selectAnswer(), after updating score:
```javascript
const xpEarned = awardXP(isCorrect);
```

3. Display XP earned in feedback:
- If correct, show "+{xpEarned} XP" near the feedback
- If streak > 1, also show "Streak x{currentStreak}!"
  </action>
  <verify>
1. Answer correctly: should see "+10 XP" on first correct
2. Answer correctly again: should see "+15 XP, Streak x2!"
3. Answer correctly third time: should see "+20 XP, Streak x3!"
4. Answer incorrectly: next correct should be back to "+10 XP"
5. Check localStorage 'gamificationData' shows updated totalXP
  </verify>
  <done>
XP awarded correctly with streak bonuses, feedback shows XP earned, streak resets on wrong answer
  </done>
</task>

<task type="auto">
  <name>Task 3: Add gamification top bar UI</name>
  <files>web/index.html</files>
  <action>
Add a gamification bar at the top of the quiz container that displays level, XP progress, and daily streak:

1. Add CSS styles for the gamification bar:
```css
.gamification-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 20px;
  border: 1px solid #e2e8f0;
}

.level-display {
  display: flex;
  align-items: center;
  gap: 12px;
}

.level-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: 700;
  font-size: 14px;
  padding: 6px 12px;
  border-radius: 20px;
  min-width: 70px;
  text-align: center;
}

.xp-bar-container {
  flex: 1;
  max-width: 150px;
  margin-left: 8px;
}

.xp-bar {
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  overflow: hidden;
}

.xp-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.5s ease;
}

.xp-text {
  font-size: 11px;
  color: #64748b;
  margin-top: 2px;
  text-align: center;
}

.streak-display {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  color: #f97316;
}

.streak-fire {
  font-size: 20px;
}

.streak-count {
  font-size: 16px;
}

.streak-label {
  font-size: 11px;
  color: #94a3b8;
}
```

2. Add HTML for gamification bar (after h1, before quiz-header):
```html
<div class="gamification-bar" id="gamification-bar">
  <div class="level-display">
    <div class="level-badge" id="level-badge">Level 1</div>
    <div class="xp-bar-container">
      <div class="xp-bar">
        <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
      </div>
      <div class="xp-text" id="xp-text">0 / 100 XP</div>
    </div>
  </div>
  <div class="streak-display" id="streak-display">
    <span class="streak-fire">ðŸ”¥</span>
    <span class="streak-count" id="streak-count">0</span>
    <span class="streak-label">day streak</span>
  </div>
</div>
```

3. Add updateGamificationUI() function:
```javascript
function updateGamificationUI() {
  const level = calculateLevel(gamificationState.totalXP);
  const xpInLevel = gamificationState.totalXP % 100;
  const xpNeeded = 100;
  const xpPercent = (xpInLevel / xpNeeded) * 100;

  document.getElementById('level-badge').textContent = `Level ${level}`;
  document.getElementById('xp-fill').style.width = xpPercent + '%';
  document.getElementById('xp-text').textContent = `${xpInLevel} / ${xpNeeded} XP`;
  document.getElementById('streak-count').textContent = gamificationState.dailyStreak;

  // Update streak label for singular/plural
  const streakLabel = document.querySelector('.streak-label');
  if (streakLabel) {
    streakLabel.textContent = gamificationState.dailyStreak === 1 ? 'day streak' : 'day streak';
  }
}
```

4. Call updateGamificationUI() in initQuiz() after loading state

5. Add responsive styles for mobile:
```css
@media (max-width: 640px) {
  .gamification-bar {
    flex-direction: column;
    gap: 12px;
    padding: 10px 14px;
  }

  .level-display {
    width: 100%;
    justify-content: center;
  }

  .xp-bar-container {
    max-width: 120px;
  }

  .streak-display {
    justify-content: center;
  }
}
```
  </action>
  <verify>
1. Page shows gamification bar at top with Level, XP bar, and streak
2. Answer correct questions: XP bar fills, level increments at 100 XP
3. Streak fire icon displays with current daily streak count
4. Mobile view: bar stacks vertically and remains readable
5. Refresh page: values persist and display correctly
  </verify>
  <done>
Gamification bar visible at top showing level, XP progress bar, and daily streak with fire icon
  </done>
</task>

</tasks>

<verification>
1. Open web/index.html in browser
2. Verify gamification bar shows at top with Level 1, 0/100 XP, 0 day streak
3. Answer 3 questions correctly in a row:
   - First: +10 XP, total 10
   - Second: +15 XP, total 25, streak x2 shown
   - Third: +20 XP, total 45, streak x3 shown
4. Answer incorrectly, then correctly: streak resets to 1, +10 XP
5. Reach 100 XP: level badge updates to "Level 2"
6. Refresh page: all values persist
7. Check localStorage for 'gamificationData' key with proper values
8. Test on mobile viewport: bar stacks properly
</verification>

<success_criteria>
- XP awarded correctly: +10 base, +5 per consecutive correct
- Level displays and updates at 100 XP thresholds
- Daily streak shows with fire icon
- All data persists in localStorage
- UI is responsive on mobile
- Streak bonus visible in feedback
</success_criteria>

<output>
After completion, create `.planning/phases/04-gamification/04-01-SUMMARY.md`
</output>
