<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Molecular Genetics Quiz</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      max-width: 800px;
      width: 100%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.05);
      padding: 40px;
    }

    h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 30px;
      text-align: center;
    }

    .quiz-header {
      margin-bottom: 25px;
    }

    .topic {
      display: inline-block;
      background: #f3f4f6;
      color: #6b7280;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .question-counter {
      color: #9ca3af;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
    }

    .question-text {
      font-size: 20px;
      color: #1f2937;
      line-height: 1.6;
      margin-bottom: 25px;
      font-weight: 500;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
    }

    .option-btn {
      background: white;
      border: 2px solid #e5e7eb;
      padding: 16px 20px;
      border-radius: 8px;
      font-size: 16px;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #374151;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .option-btn:hover:not(:disabled) {
      border-color: #667eea;
      background: #f9fafb;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .option-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .option-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .option-btn.selected {
      border-color: #667eea;
      background: #eef2ff;
    }

    .option-btn.correct {
      border-color: #22c55e;
      background: #f0fdf4;
      color: #15803d;
      animation: correctGlow 0.6s ease;
    }

    .option-btn.incorrect {
      border-color: #ef4444;
      background: #fef2f2;
      color: #991b1b;
      animation: shake 0.4s ease;
    }

    .feedback {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .feedback.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .feedback.correct {
      background: #f0fdf4;
      border: 2px solid #22c55e;
    }

    .feedback.incorrect {
      background: #fef2f2;
      border: 2px solid #ef4444;
    }

    .feedback-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 18px;
      font-weight: 600;
    }

    .feedback-header.correct {
      color: #15803d;
    }

    .feedback-header.incorrect {
      color: #991b1b;
    }

    .feedback-icon {
      font-size: 24px;
    }

    .feedback-text {
      color: #374151;
      line-height: 1.6;
    }

    .correct-answer {
      margin-top: 10px;
      font-weight: 600;
      color: #15803d;
    }

    .xp-earned {
      margin-left: auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .gamification-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
    }

    .level-display {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .level-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 700;
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 20px;
      min-width: 70px;
      text-align: center;
    }

    .xp-bar-container {
      flex: 1;
      max-width: 150px;
      margin-left: 8px;
    }

    .xp-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
    }

    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease;
    }

    .xp-text {
      font-size: 11px;
      color: #64748b;
      margin-top: 2px;
      text-align: center;
    }

    .streak-display {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      color: #f97316;
    }

    .streak-fire {
      font-size: 20px;
    }

    .streak-count {
      font-size: 16px;
    }

    .streak-label {
      font-size: 11px;
      color: #94a3b8;
    }

    .next-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: none;
      margin-top: 20px;
    }

    .next-btn.show {
      display: inline-block;
    }

    .next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .next-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 3px;
    }

    .final-score {
      display: none;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .final-score.show {
      display: block;
    }

    .score-number {
      font-size: 72px;
      font-weight: 700;
      color: #667eea;
      margin: 30px 0;
    }

    .score-percentage {
      font-size: 32px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .score-message {
      font-size: 20px;
      color: #374151;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .restart-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 16px 40px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .restart-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .restart-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 3px;
    }

    .reset-progress-btn {
      background: transparent;
      border: 1px solid #e5e7eb;
      color: #6b7280;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reset-progress-btn:hover {
      border-color: #ef4444;
      color: #ef4444;
      background: #fef2f2;
    }

    .reset-progress-btn:focus {
      outline: 2px solid #ef4444;
      outline-offset: 2px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes shake {
      0%, 100% {
        transform: translateX(0);
      }
      25% {
        transform: translateX(-8px);
      }
      75% {
        transform: translateX(8px);
      }
    }

    @keyframes correctGlow {
      0% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
      }
      50% {
        box-shadow: 0 0 20px 5px rgba(34, 197, 94, 0.3);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
      }
    }

    /* Toast notification styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }

    .achievement-toast {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3), 0 4px 10px rgba(0, 0, 0, 0.1);
      animation: toastEnter 0.5s ease forwards;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .achievement-toast.toast-exit {
      animation: toastExit 0.4s ease forwards;
    }

    .toast-icon {
      font-size: 36px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      font-size: 14px;
      color: #92400e;
      margin-bottom: 2px;
    }

    .toast-name {
      font-weight: 600;
      font-size: 16px;
      color: #78350f;
      margin-bottom: 4px;
    }

    .toast-description {
      font-size: 12px;
      color: #a16207;
    }

    @keyframes toastEnter {
      0% {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
      100% {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }

    @keyframes toastExit {
      0% {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateX(100px) scale(0.8);
      }
    }

    /* Mobile-first responsive design */
    @media (max-width: 640px) {
      body {
        padding: 12px;
      }

      .container {
        padding: 20px;
        border-radius: 8px;
      }

      .toast-container {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
      }

      .achievement-toast {
        padding: 12px;
      }

      .toast-icon {
        font-size: 28px;
      }

      .toast-name {
        font-size: 14px;
      }

      .toast-description {
        font-size: 11px;
      }

      h1 {
        font-size: 24px;
        margin-bottom: 20px;
      }

      .question-text {
        font-size: 17px;
        line-height: 1.5;
      }

      .option-btn {
        padding: 14px 16px;
        font-size: 15px;
      }

      .option-btn:hover:not(:disabled) {
        transform: translateX(2px);
      }

      .feedback {
        padding: 16px;
      }

      .feedback-header {
        font-size: 16px;
      }

      .next-btn {
        width: 100%;
        padding: 16px;
      }

      .score-number {
        font-size: 56px;
      }

      .score-percentage {
        font-size: 24px;
      }

      .score-message {
        font-size: 16px;
      }

      .restart-btn {
        width: 100%;
        padding: 16px;
      }

      .reset-progress-btn {
        font-size: 11px;
        padding: 5px 10px;
      }

      .gamification-bar {
        flex-direction: column;
        gap: 12px;
        padding: 10px 14px;
      }

      .level-display {
        width: 100%;
        justify-content: center;
      }

      .xp-bar-container {
        max-width: 120px;
      }

      .streak-display {
        justify-content: center;
      }
    }

    /* Tablet and small desktop */
    @media (min-width: 641px) and (max-width: 1024px) {
      .container {
        max-width: 700px;
        padding: 35px;
      }

      .options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
    }

    /* Large desktop - two-column options */
    @media (min-width: 1025px) {
      .options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
    }

    /* Accessibility: Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Stats Dashboard Styles */
    .stats-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .stats-btn:hover {
      background: #e2e8f0;
      transform: scale(1.1);
    }

    .stats-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .gamification-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .stats-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .stats-screen.show {
      display: block;
    }

    .stats-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .stats-title {
      color: #667eea;
      font-size: 24px;
      font-weight: 700;
    }

    .stats-close-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stats-close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .stats-close-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stats-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stats-card-value {
      font-size: 28px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 4px;
    }

    .stats-card-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stats-section {
      margin-bottom: 24px;
    }

    .stats-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .topic-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .topic-item {
      background: #f9fafb;
      border-radius: 8px;
      padding: 14px 16px;
      border: 1px solid #e5e7eb;
    }

    .topic-item.weak {
      border-color: #fed7aa;
      background: #fffbeb;
    }

    .topic-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .topic-name {
      font-weight: 600;
      color: #374151;
      font-size: 14px;
    }

    .topic-mastery {
      font-weight: 700;
      font-size: 14px;
    }

    .topic-mastery.strong {
      color: #22c55e;
    }

    .topic-mastery.medium {
      color: #667eea;
    }

    .topic-mastery.weak {
      color: #f97316;
    }

    .topic-progress {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }

    .topic-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .topic-progress-fill.strong {
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
    }

    .topic-progress-fill.medium {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .topic-progress-fill.weak {
      background: linear-gradient(90deg, #fb923c 0%, #f97316 100%);
    }

    .topic-stats-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }

    .history-list {
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      font-size: 14px;
      color: #6b7280;
    }

    .history-score {
      font-weight: 600;
      font-size: 14px;
    }

    .history-score.passing {
      color: #22c55e;
    }

    .history-score.failing {
      color: #ef4444;
    }

    .no-data-message {
      text-align: center;
      color: #9ca3af;
      padding: 24px;
      font-size: 14px;
    }

    /* Stats screen mobile styles */
    @media (max-width: 640px) {
      .stats-overview {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .stats-card {
        padding: 12px;
      }

      .stats-card-value {
        font-size: 24px;
      }

      .stats-title {
        font-size: 20px;
      }

      .gamification-actions {
        gap: 4px;
      }

      .stats-btn {
        font-size: 18px;
        padding: 2px 6px;
      }
    }

    /* Achievements Gallery Styles */
    .achievements-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .achievements-btn:hover {
      background: #fef3c7;
      transform: scale(1.1);
    }

    .achievements-btn:focus {
      outline: 2px solid #f59e0b;
      outline-offset: 2px;
    }

    .achievements-screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .achievements-screen.show {
      display: block;
    }

    .achievements-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .achievements-title {
      color: #f59e0b;
      font-size: 24px;
      font-weight: 700;
    }

    .achievements-close-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .achievements-close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .achievements-close-btn:focus {
      outline: 2px solid #f59e0b;
      outline-offset: 2px;
    }

    .achievements-progress {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #fcd34d;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      text-align: center;
    }

    .achievements-progress-text {
      font-size: 18px;
      font-weight: 600;
      color: #92400e;
    }

    .achievements-progress-bar {
      height: 10px;
      background: #fde68a;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 10px;
    }

    .achievements-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
      transition: width 0.5s ease;
    }

    .achievements-section {
      margin-bottom: 24px;
    }

    .achievements-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .achievement-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.2s ease;
    }

    .achievement-card.unlocked {
      border-color: #f59e0b;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }

    .achievement-card.locked {
      opacity: 0.6;
      filter: grayscale(0.5);
    }

    .achievement-card:hover {
      transform: translateY(-2px);
    }

    .achievement-icon {
      font-size: 40px;
      margin-bottom: 8px;
    }

    .achievement-name {
      font-weight: 600;
      font-size: 14px;
      color: #374151;
      margin-bottom: 4px;
    }

    .achievement-description {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }

    .achievement-locked-hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 8px;
      font-style: italic;
    }

    /* Achievements screen mobile styles */
    @media (max-width: 640px) {
      .achievements-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .achievement-card {
        padding: 12px;
      }

      .achievement-icon {
        font-size: 32px;
      }

      .achievement-name {
        font-size: 12px;
      }

      .achievement-description {
        font-size: 10px;
      }

      .achievements-title {
        font-size: 20px;
      }

      .achievements-btn {
        font-size: 18px;
        padding: 2px 6px;
      }
    }

    /* Home Screen / Mode Selection Styles */
    .home-screen {
      animation: fadeIn 0.3s ease;
    }

    .home-screen.hide {
      display: none;
    }

    .start-quiz-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 20px 32px;
      border-radius: 12px;
      font-size: 20px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .start-quiz-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .start-quiz-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 3px;
    }

    .quiz-count {
      font-size: 14px;
      font-weight: 500;
      opacity: 0.9;
    }

    .mode-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .mode-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .mode-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .mode-card:hover {
      border-color: #667eea;
      background: #f9fafb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .mode-card:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .mode-icon {
      font-size: 32px;
    }

    .mode-title {
      font-weight: 600;
      font-size: 15px;
      color: #374151;
    }

    .mode-desc {
      font-size: 12px;
      color: #6b7280;
      line-height: 1.4;
    }

    /* Mode cards mobile responsive */
    @media (max-width: 640px) {
      .mode-cards {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .mode-card {
        flex-direction: row;
        text-align: left;
        padding: 14px 16px;
        gap: 12px;
      }

      .mode-icon {
        font-size: 28px;
        flex-shrink: 0;
      }

      .mode-card-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .start-quiz-btn {
        padding: 16px 24px;
        font-size: 18px;
      }
    }

    /* Topic Selector Modal Styles */
    .topic-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .topic-modal.show {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .topic-modal-content {
      background: white;
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .topic-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .topic-modal-header h3 {
      font-size: 20px;
      font-weight: 700;
      color: #667eea;
      margin: 0;
    }

    .topic-close-btn {
      background: #f3f4f6;
      border: none;
      color: #6b7280;
      font-size: 20px;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .topic-close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .topic-close-btn:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .topic-list-modal {
      padding: 16px;
      max-height: calc(80vh - 80px);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .topic-select-item {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .topic-select-item:hover {
      border-color: #667eea;
      background: white;
      transform: translateX(4px);
    }

    .topic-select-item:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    .topic-select-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .topic-select-name {
      font-weight: 600;
      font-size: 15px;
      color: #374151;
    }

    .topic-select-count {
      font-size: 13px;
      color: #6b7280;
      background: #e5e7eb;
      padding: 2px 8px;
      border-radius: 12px;
    }

    .topic-select-progress {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .topic-select-progress-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .topic-select-progress-fill.strong {
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 100%);
    }

    .topic-select-progress-fill.medium {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }

    .topic-select-progress-fill.weak {
      background: linear-gradient(90deg, #fb923c 0%, #f97316 100%);
    }

    .topic-select-mastery {
      font-size: 12px;
      margin-top: 6px;
      font-weight: 600;
    }

    .topic-select-mastery.strong {
      color: #22c55e;
    }

    .topic-select-mastery.medium {
      color: #667eea;
    }

    .topic-select-mastery.weak {
      color: #f97316;
    }

    /* Quiz mode indicator */
    .mode-indicator {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      display: inline-block;
    }

    .back-to-home {
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .back-to-home:hover {
      color: #667eea;
      background: #f3f4f6;
    }

    .back-to-home:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    /* Topic modal mobile */
    @media (max-width: 640px) {
      .topic-modal {
        padding: 10px;
      }

      .topic-modal-content {
        max-height: 90vh;
      }

      .topic-modal-header {
        padding: 16px 20px;
      }

      .topic-modal-header h3 {
        font-size: 18px;
      }

      .topic-list-modal {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Toast notification container -->
  <div class="toast-container" id="toast-container"></div>

  <div class="container">
    <h1>Molecular Genetics Quiz</h1>

    <div class="gamification-bar" id="gamification-bar">
      <div class="level-display">
        <div class="level-badge" id="level-badge">Level 1</div>
        <div class="xp-bar-container">
          <div class="xp-bar">
            <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
          </div>
          <div class="xp-text" id="xp-text">0 / 100 XP</div>
        </div>
      </div>
      <div class="gamification-actions">
        <div class="streak-display" id="streak-display">
          <span class="streak-fire">&#128293;</span>
          <span class="streak-count" id="streak-count">0</span>
          <span class="streak-label">day streak</span>
        </div>
        <button class="achievements-btn" onclick="showAchievements()" title="View Achievements">&#127942;</button>
        <button class="stats-btn" onclick="showStats()" title="View Progress Stats">&#128202;</button>
      </div>
    </div>

    <!-- Home Screen / Mode Selection -->
    <div id="home-screen" class="home-screen">
      <button class="start-quiz-btn" onclick="startStandardQuiz()">
        Start Full Quiz
        <span class="quiz-count" id="full-quiz-count">(49 questions)</span>
      </button>

      <div class="mode-section-title">Study Modes</div>

      <div class="mode-cards">
        <div class="mode-card" onclick="showTopicSelector()" tabindex="0" role="button">
          <span class="mode-icon">&#128218;</span>
          <div class="mode-card-text">
            <span class="mode-title">By Topic</span>
            <span class="mode-desc">Focus on specific subjects</span>
          </div>
        </div>

        <div class="mode-card" onclick="startWeakSpotsQuiz()" tabindex="0" role="button">
          <span class="mode-icon">&#127919;</span>
          <div class="mode-card-text">
            <span class="mode-title">Weak Spots</span>
            <span class="mode-desc" id="weak-spots-count">Review missed questions</span>
          </div>
        </div>

        <div class="mode-card" onclick="startFlashcards()" tabindex="0" role="button">
          <span class="mode-icon">&#127183;</span>
          <div class="mode-card-text">
            <span class="mode-title">Flashcards</span>
            <span class="mode-desc">Tap to reveal answers</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Topic Selector Modal -->
    <div id="topic-modal" class="topic-modal" onclick="handleTopicModalClick(event)">
      <div class="topic-modal-content">
        <div class="topic-modal-header">
          <h3>Select a Topic</h3>
          <button class="topic-close-btn" onclick="hideTopicSelector()">&#10005;</button>
        </div>
        <div class="topic-list-modal" id="topic-list-modal">
          <!-- Populated by renderTopicSelector() -->
        </div>
      </div>
    </div>

    <div id="quiz-area" style="display: none;">
      <div class="quiz-header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div class="topic" id="topic"></div>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="goToHomeScreen()" class="back-to-home">Back to Home</button>
            <button onclick="resetProgressWithConfirmation()" class="reset-progress-btn">Reset Progress</button>
          </div>
        </div>
        <div class="question-counter" id="counter"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress"></div>
        </div>
      </div>

      <div class="question-text" id="question"></div>

      <div class="options" id="options"></div>

      <div id="feedback" class="feedback">
        <div class="feedback-header">
          <span class="feedback-icon" id="feedback-icon"></span>
          <span id="feedback-title"></span>
          <span class="xp-earned" id="xp-earned"></span>
        </div>
        <div class="feedback-text" id="feedback-explanation"></div>
        <div class="correct-answer" id="correct-answer"></div>
      </div>

      <button class="next-btn" id="next-btn" onclick="nextQuestion()">Next Question</button>
    </div>

    <div id="final-score" class="final-score">
      <h2 style="color: #667eea; font-size: 36px;">Quiz Complete!</h2>
      <div class="score-number" id="score-number"></div>
      <div class="score-percentage" id="score-percentage"></div>
      <div class="score-message" id="score-message"></div>
      <div id="quiz-history"></div>
      <button class="restart-btn" onclick="resetQuiz()">Try Again</button>
    </div>

    <!-- Stats Dashboard Screen -->
    <div id="stats-screen" class="stats-screen">
      <div class="stats-header">
        <h2 class="stats-title">Your Progress</h2>
        <button class="stats-close-btn" onclick="hideStats()" title="Close">&#10005;</button>
      </div>

      <div class="stats-overview" id="stats-overview">
        <!-- Populated by renderStats() -->
      </div>

      <div class="stats-section">
        <div class="stats-section-title">&#128218; Topic Mastery</div>
        <div class="topic-list" id="topic-list">
          <!-- Populated by renderStats() -->
        </div>
      </div>

      <div class="stats-section">
        <div class="stats-section-title">&#128197; Quiz History</div>
        <div class="history-list" id="stats-history-list">
          <!-- Populated by renderStats() -->
        </div>
      </div>
    </div>

    <!-- Achievements Gallery Screen -->
    <div id="achievements-screen" class="achievements-screen">
      <div class="achievements-header">
        <h2 class="achievements-title">Achievements</h2>
        <button class="achievements-close-btn" onclick="hideAchievements()" title="Close">&#10005;</button>
      </div>

      <div class="achievements-progress" id="achievements-progress">
        <!-- Populated by renderAchievements() -->
      </div>

      <div class="achievements-section">
        <div class="achievements-section-title">&#127942; Milestones</div>
        <div class="achievements-grid" id="milestones-grid">
          <!-- Populated by renderAchievements() -->
        </div>
      </div>

      <div class="achievements-section">
        <div class="achievements-section-title">&#129516; Topic Mastery</div>
        <div class="achievements-grid" id="mastery-grid">
          <!-- Populated by renderAchievements() -->
        </div>
      </div>
    </div>
  </div>

  <script src="questions.js"></script>
  <script>
    // Quiz state
    let currentQuestionIndex = 0;
    let score = 0;
    let shuffledQuestions = [];
    let hasAnswered = false;
    let questionResults = {}; // Track which questions answered and correctness

    // Mode state
    let currentMode = 'standard'; // 'standard', 'topic', 'weak', 'flashcard'
    let currentTopic = null;

    // Gamification state
    let gamificationState = {
      totalXP: 0,
      currentStreak: 0,       // consecutive correct in current session
      dailyStreak: 0,         // days studied in a row
      lastStudyDate: null,    // ISO date string (YYYY-MM-DD)
      questionsToday: 0,      // questions answered today
      todayDate: null,        // current date for reset detection
      topicStats: {},         // per-topic tracking: { "Topic Name": { correct: N, total: M } }
      unlockedAchievements: [], // array of unlocked achievement IDs
      totalQuestionsAnswered: 0, // lifetime questions answered
      quizzesCompleted: 0     // number of full quizzes completed
    };

    // Achievement definitions - milestone achievements
    const achievementDefinitions = [
      // Correct answer milestones
      { id: 'first_correct', name: 'First Steps', icon: '&#127793;', description: 'Answer your first question correctly', type: 'milestone', requirement: { metric: 'totalCorrect', value: 1 } },
      { id: 'ten_correct', name: 'Getting Started', icon: '&#128218;', description: 'Answer 10 questions correctly', type: 'milestone', requirement: { metric: 'totalCorrect', value: 10 } },
      { id: 'fifty_correct', name: 'Dedicated Learner', icon: '&#127919;', description: 'Answer 50 questions correctly', type: 'milestone', requirement: { metric: 'totalCorrect', value: 50 } },
      { id: 'hundred_correct', name: 'Century Club', icon: '&#128175;', description: 'Answer 100 questions correctly', type: 'milestone', requirement: { metric: 'totalCorrect', value: 100 } },
      // Quiz completion milestones
      { id: 'first_quiz', name: 'Quiz Taker', icon: '&#128221;', description: 'Complete your first quiz', type: 'milestone', requirement: { metric: 'quizzesCompleted', value: 1 } },
      { id: 'five_quizzes', name: 'Quiz Regular', icon: '&#127939;', description: 'Complete 5 quizzes', type: 'milestone', requirement: { metric: 'quizzesCompleted', value: 5 } },
      { id: 'ten_quizzes', name: 'Quiz Master', icon: '&#127942;', description: 'Complete 10 quizzes', type: 'milestone', requirement: { metric: 'quizzesCompleted', value: 10 } },
      // Level milestones
      { id: 'level_5', name: 'Rising Star', icon: '&#11088;', description: 'Reach Level 5', type: 'milestone', requirement: { metric: 'level', value: 5 } },
      { id: 'level_10', name: 'Expert', icon: '&#127775;', description: 'Reach Level 10', type: 'milestone', requirement: { metric: 'level', value: 10 } },
      // Answer streak milestones
      { id: 'streak_3', name: 'On Fire', icon: '&#128293;', description: 'Get 3 correct answers in a row', type: 'milestone', requirement: { metric: 'currentStreak', value: 3 } },
      { id: 'streak_5', name: 'Unstoppable', icon: '&#9889;', description: 'Get 5 correct answers in a row', type: 'milestone', requirement: { metric: 'currentStreak', value: 5 } },
      { id: 'streak_10', name: 'Legendary Streak', icon: '&#127752;', description: 'Get 10 correct answers in a row', type: 'milestone', requirement: { metric: 'currentStreak', value: 10 } },
      // Daily streak milestones
      { id: 'daily_3', name: 'Consistent', icon: '&#128197;', description: 'Study for 3 days in a row', type: 'milestone', requirement: { metric: 'dailyStreak', value: 3 } },
      { id: 'daily_7', name: 'Week Warrior', icon: '&#128198;', description: 'Study for 7 days in a row', type: 'milestone', requirement: { metric: 'dailyStreak', value: 7 } },
      // Special achievements
      { id: 'perfect_quiz', name: 'Perfect Score', icon: '&#128142;', description: 'Complete a quiz with 100% accuracy', type: 'milestone', requirement: { metric: 'perfectQuiz', value: true } }
    ];

    // Generate topic mastery achievements dynamically from questions
    function generateTopicMasteryAchievements() {
      const topics = [...new Set(questions.map(q => q.topic))];
      return topics.map(topic => ({
        id: `mastery_${topic.toLowerCase().replace(/\s+/g, '_')}`,
        name: `${topic} Master`,
        icon: '&#129516;',
        description: `Answer all ${topic} questions correctly (100%)`,
        type: 'mastery',
        topic: topic,
        requirement: { metric: 'topicMastery', topic: topic, value: 100 }
      }));
    }

    // Combine all achievements (populated after questions load)
    let allAchievements = [...achievementDefinitions];

    // Gamification helper functions
    function getCurrentDateString() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function calculateLevel(xp) {
      return Math.floor(xp / 100) + 1;
    }

    function getXPForNextLevel(xp) {
      return 100 - (xp % 100);
    }

    // Topic tracking functions
    function updateTopicStats(question, isCorrect) {
      const topic = question.topic;
      if (!gamificationState.topicStats[topic]) {
        gamificationState.topicStats[topic] = { correct: 0, total: 0 };
      }
      gamificationState.topicStats[topic].total++;
      if (isCorrect) {
        gamificationState.topicStats[topic].correct++;
      }
    }

    function getTopicMastery(topic) {
      const stats = gamificationState.topicStats[topic];
      if (!stats || stats.total === 0) return 0;
      return Math.round((stats.correct / stats.total) * 100);
    }

    function getAllTopicStats() {
      const result = [];
      for (const topic in gamificationState.topicStats) {
        const stats = gamificationState.topicStats[topic];
        result.push({
          topic: topic,
          correct: stats.correct,
          total: stats.total,
          mastery: getTopicMastery(topic)
        });
      }
      // Sort by mastery (ascending - weakest first)
      result.sort((a, b) => a.mastery - b.mastery);
      return result;
    }

    // Gamification localStorage functions
    function saveGamificationState() {
      try {
        localStorage.setItem('gamificationData', JSON.stringify(gamificationState));
      } catch (e) {
        console.error('Failed to save gamification state:', e);
      }
    }

    function loadGamificationState() {
      try {
        const saved = localStorage.getItem('gamificationData');
        if (!saved) return false;

        const loaded = JSON.parse(saved);

        // Validate structure
        if (typeof loaded.totalXP !== 'number') return false;

        const currentDate = getCurrentDateString();

        // Check if it's a new day
        if (loaded.todayDate !== currentDate) {
          // Check if previous day had 10+ questions to maintain daily streak
          if (loaded.lastStudyDate && loaded.questionsToday >= 10) {
            // Check if lastStudyDate was yesterday
            const lastDate = new Date(loaded.lastStudyDate);
            const today = new Date(currentDate);
            const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
              // Consecutive day - increment daily streak
              loaded.dailyStreak = (loaded.dailyStreak || 0) + 1;
            } else if (diffDays > 1) {
              // Missed a day - reset streak
              loaded.dailyStreak = 0;
            }
          } else if (loaded.todayDate !== null) {
            // Previous day didn't have 10+ questions - reset streak
            loaded.dailyStreak = 0;
          }

          // Reset daily counters for new day
          loaded.questionsToday = 0;
          loaded.todayDate = currentDate;
        }

        // Apply loaded state
        gamificationState = {
          totalXP: loaded.totalXP || 0,
          currentStreak: 0, // Always reset session streak on load
          dailyStreak: loaded.dailyStreak || 0,
          lastStudyDate: loaded.lastStudyDate || null,
          questionsToday: loaded.questionsToday || 0,
          todayDate: loaded.todayDate || currentDate,
          topicStats: loaded.topicStats || {},
          unlockedAchievements: loaded.unlockedAchievements || [],
          totalQuestionsAnswered: loaded.totalQuestionsAnswered || 0,
          quizzesCompleted: loaded.quizzesCompleted || 0
        };

        saveGamificationState(); // Save any updates made during load
        return true;
      } catch (e) {
        console.error('Failed to load gamification state:', e);
        // Start fresh on error
        gamificationState = {
          totalXP: 0,
          currentStreak: 0,
          dailyStreak: 0,
          lastStudyDate: null,
          questionsToday: 0,
          todayDate: getCurrentDateString(),
          topicStats: {},
          unlockedAchievements: [],
          totalQuestionsAnswered: 0,
          quizzesCompleted: 0
        };
        return false;
      }
    }

    // Award XP for answers
    function awardXP(isCorrect) {
      if (isCorrect) {
        // Base XP
        let xpEarned = 10;

        // Increment answer streak
        gamificationState.currentStreak++;

        // Streak bonus: +5 per consecutive correct answer
        // 1st correct: 10 XP (no bonus)
        // 2nd correct: 10 + 5 = 15 XP
        // 3rd correct: 10 + 10 = 20 XP
        if (gamificationState.currentStreak > 1) {
          xpEarned += (gamificationState.currentStreak - 1) * 5;
        }

        gamificationState.totalXP += xpEarned;
        gamificationState.questionsToday++;

        // Update last study date
        gamificationState.lastStudyDate = getCurrentDateString();

        saveGamificationState();
        updateGamificationUI();

        return xpEarned;
      } else {
        // Reset answer streak on incorrect
        gamificationState.currentStreak = 0;
        gamificationState.questionsToday++;
        gamificationState.lastStudyDate = getCurrentDateString();
        saveGamificationState();
        updateGamificationUI();
        return 0;
      }
    }

    // Update gamification UI
    function updateGamificationUI() {
      const level = calculateLevel(gamificationState.totalXP);
      const xpInLevel = gamificationState.totalXP % 100;
      const xpNeeded = 100;
      const xpPercent = (xpInLevel / xpNeeded) * 100;

      document.getElementById('level-badge').textContent = `Level ${level}`;
      document.getElementById('xp-fill').style.width = xpPercent + '%';
      document.getElementById('xp-text').textContent = `${xpInLevel} / ${xpNeeded} XP`;
      document.getElementById('streak-count').textContent = gamificationState.dailyStreak;

      // Update streak label for singular/plural
      const streakLabel = document.querySelector('.streak-label');
      if (streakLabel) {
        streakLabel.textContent = gamificationState.dailyStreak === 1 ? 'day streak' : 'day streak';
      }
    }

    // Achievement toast notification
    function showAchievementToast(achievement) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'achievement-toast';
      toast.innerHTML = `
        <span class="toast-icon">${achievement.icon}</span>
        <div class="toast-content">
          <div class="toast-title">Achievement Unlocked!</div>
          <div class="toast-name">${achievement.name}</div>
          <div class="toast-description">${achievement.description}</div>
        </div>
      `;
      container.appendChild(toast);

      // Auto-dismiss after 4 seconds
      setTimeout(() => {
        toast.classList.add('toast-exit');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 400);
      }, 4000);
    }

    // Calculate total correct answers from topic stats
    function getTotalCorrect() {
      let total = 0;
      for (const topic in gamificationState.topicStats) {
        total += gamificationState.topicStats[topic].correct;
      }
      return total;
    }

    // Check and unlock achievements
    function checkAchievements(context = {}) {
      const unlockedNow = [];

      allAchievements.forEach(achievement => {
        // Skip if already unlocked
        if (gamificationState.unlockedAchievements.includes(achievement.id)) {
          return;
        }

        let isUnlocked = false;
        const req = achievement.requirement;

        switch (req.metric) {
          case 'totalCorrect':
            isUnlocked = getTotalCorrect() >= req.value;
            break;
          case 'quizzesCompleted':
            isUnlocked = gamificationState.quizzesCompleted >= req.value;
            break;
          case 'level':
            isUnlocked = calculateLevel(gamificationState.totalXP) >= req.value;
            break;
          case 'currentStreak':
            isUnlocked = gamificationState.currentStreak >= req.value;
            break;
          case 'dailyStreak':
            isUnlocked = gamificationState.dailyStreak >= req.value;
            break;
          case 'perfectQuiz':
            isUnlocked = context.perfectQuiz === true;
            break;
          case 'topicMastery':
            isUnlocked = checkTopicMastery(achievement.topic);
            break;
        }

        if (isUnlocked) {
          gamificationState.unlockedAchievements.push(achievement.id);
          unlockedNow.push(achievement);
        }
      });

      // Show toast for newly unlocked achievements
      unlockedNow.forEach((achievement, index) => {
        // Stagger toasts if multiple unlocked
        setTimeout(() => {
          showAchievementToast(achievement);
        }, index * 500);
      });

      // Save state if any achievements were unlocked
      if (unlockedNow.length > 0) {
        saveGamificationState();
      }

      return unlockedNow;
    }

    // Check if a topic has 100% mastery (all questions answered correctly)
    function checkTopicMastery(topic) {
      const stats = gamificationState.topicStats[topic];
      if (!stats) return false;

      // Get total questions for this topic
      const topicQuestions = questions.filter(q => q.topic === topic);
      const totalQuestionsForTopic = topicQuestions.length;

      // Must have answered all questions for this topic AND gotten all correct
      return stats.total >= totalQuestionsForTopic && stats.correct === stats.total && stats.total > 0;
    }

    // Check for perfect score achievement
    function checkPerfectScore(quizScore, totalQuestions) {
      return quizScore === totalQuestions;
    }

    // Fisher-Yates shuffle algorithm
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // LocalStorage functions
    function saveProgress() {
      try {
        const progress = {
          currentQuestionIndex,
          score,
          questionsOrder: shuffledQuestions.map(q => q.id),
          questionResults,
          lastAttemptDate: new Date().toISOString()
        };
        localStorage.setItem('quizProgress', JSON.stringify(progress));
      } catch (e) {
        console.error('Failed to save progress:', e);
      }
    }

    function loadProgress() {
      try {
        const saved = localStorage.getItem('quizProgress');
        if (!saved) return false;

        const progress = JSON.parse(saved);

        // Validate saved data
        if (!progress.questionsOrder || !Array.isArray(progress.questionsOrder)) {
          return false;
        }

        // Check if question set has changed
        if (progress.questionsOrder.length !== questions.length) {
          console.warn('Question set changed, starting fresh');
          resetProgress();
          return false;
        }

        // Restore shuffled order
        shuffledQuestions = progress.questionsOrder.map(id =>
          questions.find(q => q.id === id)
        ).filter(q => q !== undefined);

        // If we couldn't restore all questions, start fresh
        if (shuffledQuestions.length !== questions.length) {
          console.warn('Could not restore all questions, starting fresh');
          resetProgress();
          return false;
        }

        currentQuestionIndex = progress.currentQuestionIndex || 0;
        score = progress.score || 0;
        questionResults = progress.questionResults || {};

        // If quiz was already completed, don't restore
        if (currentQuestionIndex >= shuffledQuestions.length) {
          return false;
        }

        return true;
      } catch (e) {
        console.error('Failed to load progress:', e);
        resetProgress();
        return false;
      }
    }

    function resetProgress() {
      try {
        localStorage.removeItem('quizProgress');
        questionResults = {};
      } catch (e) {
        console.error('Failed to reset progress:', e);
      }
    }

    function saveQuizHistory(score, total) {
      try {
        let history = JSON.parse(localStorage.getItem('quizHistory') || '[]');
        const percentage = Math.round((score / total) * 100);

        history.unshift({
          date: new Date().toISOString(),
          score,
          total,
          percentage
        });

        // Keep only last 10 attempts
        history = history.slice(0, 10);

        localStorage.setItem('quizHistory', JSON.stringify(history));
      } catch (e) {
        console.error('Failed to save history:', e);
      }
    }

    function getQuizHistory() {
      try {
        return JSON.parse(localStorage.getItem('quizHistory') || '[]');
      } catch (e) {
        console.error('Failed to load history:', e);
        return [];
      }
    }

    // Stats Dashboard Functions
    function showStats() {
      hideHomeScreen();
      document.getElementById('quiz-area').style.display = 'none';
      document.getElementById('final-score').classList.remove('show');
      document.getElementById('achievements-screen').classList.remove('show');
      document.getElementById('stats-screen').classList.add('show');
      renderStats();
    }

    function hideStats() {
      document.getElementById('stats-screen').classList.remove('show');
      showHomeScreen();
    }

    // Achievements Gallery Functions
    function showAchievements() {
      hideHomeScreen();
      document.getElementById('quiz-area').style.display = 'none';
      document.getElementById('final-score').classList.remove('show');
      document.getElementById('stats-screen').classList.remove('show');
      document.getElementById('achievements-screen').classList.add('show');
      renderAchievements();
    }

    function hideAchievements() {
      document.getElementById('achievements-screen').classList.remove('show');
      showHomeScreen();
    }

    function renderAchievements() {
      renderAchievementsProgress();
      renderMilestonesGrid();
      renderMasteryGrid();
    }

    function renderAchievementsProgress() {
      const total = allAchievements.length;
      const unlocked = gamificationState.unlockedAchievements.length;
      const percentage = total > 0 ? Math.round((unlocked / total) * 100) : 0;

      const progressContainer = document.getElementById('achievements-progress');
      progressContainer.innerHTML = `
        <div class="achievements-progress-text">${unlocked} of ${total} achievements unlocked</div>
        <div class="achievements-progress-bar">
          <div class="achievements-progress-fill" style="width: ${percentage}%"></div>
        </div>
      `;
    }

    function renderMilestonesGrid() {
      const milestonesGrid = document.getElementById('milestones-grid');
      const milestoneAchievements = allAchievements.filter(a => a.type === 'milestone');

      milestonesGrid.innerHTML = milestoneAchievements.map(achievement =>
        renderAchievementCard(achievement)
      ).join('');
    }

    function renderMasteryGrid() {
      const masteryGrid = document.getElementById('mastery-grid');
      const masteryAchievements = allAchievements.filter(a => a.type === 'mastery');

      masteryGrid.innerHTML = masteryAchievements.map(achievement =>
        renderAchievementCard(achievement)
      ).join('');
    }

    function renderAchievementCard(achievement) {
      const isUnlocked = gamificationState.unlockedAchievements.includes(achievement.id);
      const cardClass = isUnlocked ? 'unlocked' : 'locked';

      let hintText = '';
      if (!isUnlocked) {
        hintText = getAchievementHint(achievement);
      }

      return `
        <div class="achievement-card ${cardClass}">
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-name">${achievement.name}</div>
          <div class="achievement-description">${achievement.description}</div>
          ${!isUnlocked ? `<div class="achievement-locked-hint">${hintText}</div>` : ''}
        </div>
      `;
    }

    function getAchievementHint(achievement) {
      const req = achievement.requirement;

      switch (req.metric) {
        case 'totalCorrect':
          const currentCorrect = getTotalCorrect();
          return `${currentCorrect}/${req.value} correct`;
        case 'quizzesCompleted':
          return `${gamificationState.quizzesCompleted}/${req.value} quizzes`;
        case 'level':
          const currentLevel = calculateLevel(gamificationState.totalXP);
          return `Level ${currentLevel}/${req.value}`;
        case 'currentStreak':
          return `Best in session: ${gamificationState.currentStreak}/${req.value}`;
        case 'dailyStreak':
          return `${gamificationState.dailyStreak}/${req.value} days`;
        case 'perfectQuiz':
          return 'Get 100% on a quiz';
        case 'topicMastery':
          const topicStats = gamificationState.topicStats[achievement.topic];
          if (!topicStats) {
            return 'Answer questions from this topic';
          }
          const mastery = getTopicMastery(achievement.topic);
          return `${mastery}% mastery`;
        default:
          return 'Keep studying!';
      }
    }

    function renderStats() {
      renderOverviewCards();
      renderTopicList();
      renderStatsHistory();
    }

    function renderOverviewCards() {
      const level = calculateLevel(gamificationState.totalXP);
      const totalCorrect = getTotalCorrect();
      const totalAnswered = gamificationState.totalQuestionsAnswered;
      const accuracy = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;

      const overviewContainer = document.getElementById('stats-overview');
      overviewContainer.innerHTML = `
        <div class="stats-card">
          <div class="stats-card-value">${level}</div>
          <div class="stats-card-label">Level</div>
        </div>
        <div class="stats-card">
          <div class="stats-card-value">${gamificationState.totalXP}</div>
          <div class="stats-card-label">Total XP</div>
        </div>
        <div class="stats-card">
          <div class="stats-card-value">${accuracy}%</div>
          <div class="stats-card-label">Accuracy</div>
        </div>
        <div class="stats-card">
          <div class="stats-card-value">${gamificationState.quizzesCompleted}</div>
          <div class="stats-card-label">Quizzes</div>
        </div>
      `;
    }

    function renderTopicList() {
      const topicListContainer = document.getElementById('topic-list');
      const topicStats = getAllTopicStats();

      if (topicStats.length === 0) {
        topicListContainer.innerHTML = '<div class="no-data-message">Answer some questions to see topic progress</div>';
        return;
      }

      topicListContainer.innerHTML = topicStats.map(stat => renderTopicItem(stat)).join('');
    }

    function renderTopicItem(stat) {
      const masteryClass = stat.mastery >= 80 ? 'strong' : (stat.mastery >= 70 ? 'medium' : 'weak');
      const isWeak = stat.mastery < 70;

      return `
        <div class="topic-item ${isWeak ? 'weak' : ''}">
          <div class="topic-header">
            <span class="topic-name">${stat.topic}</span>
            <span class="topic-mastery ${masteryClass}">${stat.mastery}%</span>
          </div>
          <div class="topic-progress">
            <div class="topic-progress-fill ${masteryClass}" style="width: ${stat.mastery}%"></div>
          </div>
          <div class="topic-stats-text">${stat.correct} of ${stat.total} correct</div>
        </div>
      `;
    }

    function renderStatsHistory() {
      const historyContainer = document.getElementById('stats-history-list');
      const history = getQuizHistory();

      if (history.length === 0) {
        historyContainer.innerHTML = '<div class="no-data-message">Complete a quiz to see history</div>';
        return;
      }

      historyContainer.innerHTML = history.slice(0, 10).map(attempt => renderHistoryItem(attempt)).join('');
    }

    function renderHistoryItem(attempt) {
      const date = new Date(attempt.date);
      const dateStr = date.toLocaleDateString();
      const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const isPassing = attempt.percentage >= 70;

      return `
        <div class="history-item">
          <span class="history-date">${dateStr} ${timeStr}</span>
          <span class="history-score ${isPassing ? 'passing' : 'failing'}">${attempt.score}/${attempt.total} (${attempt.percentage}%)</span>
        </div>
      `;
    }

    // Home Screen Functions
    function showHomeScreen() {
      document.getElementById('home-screen').classList.remove('hide');
      document.getElementById('quiz-area').style.display = 'none';
      document.getElementById('final-score').classList.remove('show');
      document.getElementById('stats-screen').classList.remove('show');
      document.getElementById('achievements-screen').classList.remove('show');

      // Update full quiz count
      document.getElementById('full-quiz-count').textContent = `(${questions.length} questions)`;

      // Update weak spots count
      updateWeakSpotsCount();
    }

    function hideHomeScreen() {
      document.getElementById('home-screen').classList.add('hide');
    }

    function updateWeakSpotsCount() {
      const weakTopics = getAllTopicStats().filter(t => t.mastery < 70);
      const weakSpotsDesc = document.getElementById('weak-spots-count');
      if (weakTopics.length > 0) {
        weakSpotsDesc.textContent = `${weakTopics.length} topics need work`;
      } else if (Object.keys(gamificationState.topicStats).length === 0) {
        weakSpotsDesc.textContent = 'Review missed questions';
      } else {
        weakSpotsDesc.textContent = 'No weak spots found!';
      }
    }

    // Standard Quiz Mode
    function startStandardQuiz() {
      currentMode = 'standard';
      currentTopic = null;
      hideHomeScreen();

      // Start fresh quiz with all questions
      shuffledQuestions = shuffleArray(questions);
      currentQuestionIndex = 0;
      score = 0;
      questionResults = {};
      hasAnswered = false;

      document.getElementById('quiz-area').style.display = 'block';
      displayQuestion();
      saveProgress();
    }

    // Topic Selector Functions
    function showTopicSelector() {
      renderTopicSelector();
      document.getElementById('topic-modal').classList.add('show');
    }

    function hideTopicSelector() {
      document.getElementById('topic-modal').classList.remove('show');
    }

    function handleTopicModalClick(event) {
      // Close modal if clicking outside content
      if (event.target.classList.contains('topic-modal')) {
        hideTopicSelector();
      }
    }

    function renderTopicSelector() {
      const topicListModal = document.getElementById('topic-list-modal');

      // Get unique topics from questions
      const topics = [...new Set(questions.map(q => q.topic))].sort();

      topicListModal.innerHTML = topics.map(topic => {
        const topicQuestions = questions.filter(q => q.topic === topic);
        const count = topicQuestions.length;
        const mastery = getTopicMastery(topic);
        const masteryClass = mastery >= 80 ? 'strong' : (mastery >= 70 ? 'medium' : 'weak');
        const hasAttempted = gamificationState.topicStats[topic] && gamificationState.topicStats[topic].total > 0;

        return `
          <div class="topic-select-item" onclick="startTopicQuiz('${topic}')" tabindex="0" role="button">
            <div class="topic-select-header">
              <span class="topic-select-name">${topic}</span>
              <span class="topic-select-count">${count} questions</span>
            </div>
            <div class="topic-select-progress">
              <div class="topic-select-progress-fill ${masteryClass}" style="width: ${mastery}%"></div>
            </div>
            <div class="topic-select-mastery ${masteryClass}">
              ${hasAttempted ? `${mastery}% mastery` : 'Not started'}
            </div>
          </div>
        `;
      }).join('');
    }

    // Topic Quiz Mode
    function startTopicQuiz(topic) {
      currentMode = 'topic';
      currentTopic = topic;
      hideTopicSelector();
      hideHomeScreen();

      // Filter questions by topic and shuffle
      shuffledQuestions = shuffleArray(questions.filter(q => q.topic === topic));
      currentQuestionIndex = 0;
      score = 0;
      questionResults = {};
      hasAnswered = false;

      document.getElementById('quiz-area').style.display = 'block';
      displayQuestion();
      saveProgress();
    }

    // Weak Spots Quiz Mode (placeholder for future implementation)
    function startWeakSpotsQuiz() {
      const weakTopics = getAllTopicStats().filter(t => t.mastery < 70);

      if (weakTopics.length === 0 && Object.keys(gamificationState.topicStats).length > 0) {
        alert('Great job! You have no weak spots. All topics are at 70% or higher mastery.');
        return;
      }

      if (Object.keys(gamificationState.topicStats).length === 0) {
        alert('Complete some questions first to identify your weak spots.');
        return;
      }

      currentMode = 'weak';
      currentTopic = null;
      hideHomeScreen();

      // Get questions from weak topics
      const weakTopicNames = weakTopics.map(t => t.topic);
      shuffledQuestions = shuffleArray(questions.filter(q => weakTopicNames.includes(q.topic)));
      currentQuestionIndex = 0;
      score = 0;
      questionResults = {};
      hasAnswered = false;

      document.getElementById('quiz-area').style.display = 'block';
      displayQuestion();
      saveProgress();
    }

    // Flashcards Mode (placeholder for future implementation)
    function startFlashcards() {
      alert('Flashcards mode coming soon in Phase 5-02!');
    }

    // Initialize quiz
    function initQuiz() {
      // Generate topic mastery achievements now that questions are loaded
      allAchievements = [...achievementDefinitions, ...generateTopicMasteryAchievements()];

      // Load gamification state first
      loadGamificationState();
      updateGamificationUI();

      // Try to load saved progress
      const hasProgress = loadProgress();

      if (hasProgress && currentQuestionIndex > 0 && currentQuestionIndex < shuffledQuestions.length) {
        // Resume existing quiz
        hasAnswered = false;
        hideHomeScreen();
        document.getElementById('quiz-area').style.display = 'block';
        document.getElementById('final-score').classList.remove('show');
        document.getElementById('stats-screen').classList.remove('show');
        document.getElementById('achievements-screen').classList.remove('show');
        showResumingMessage();
        displayQuestion();
      } else {
        // Show home screen for fresh start
        currentMode = 'standard';
        currentTopic = null;
        showHomeScreen();
      }
    }

    // Display current question
    function displayQuestion() {
      hasAnswered = false;
      const question = shuffledQuestions[currentQuestionIndex];
      const totalQuestions = shuffledQuestions.length;
      const progress = ((currentQuestionIndex + 1) / totalQuestions) * 100;

      // Update header based on mode
      const topicEl = document.getElementById('topic');
      if (currentMode === 'topic' && currentTopic) {
        topicEl.innerHTML = `<span class="mode-indicator">Topic: ${currentTopic}</span>`;
      } else if (currentMode === 'weak') {
        topicEl.innerHTML = `<span class="mode-indicator">Weak Spots</span> ${question.topic}`;
      } else {
        topicEl.textContent = question.topic;
      }

      document.getElementById('counter').textContent = `Question ${currentQuestionIndex + 1} of ${totalQuestions}`;
      document.getElementById('progress').style.width = progress + '%';

      // Update question text
      document.getElementById('question').textContent = question.question;

      // Create option buttons
      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';

      question.options.forEach((option, index) => {
        const button = document.createElement('button');
        button.className = 'option-btn';
        button.textContent = option;
        button.onclick = () => selectAnswer(option.charAt(0));
        optionsContainer.appendChild(button);
      });

      // Hide feedback and next button
      document.getElementById('feedback').classList.remove('show', 'correct', 'incorrect');
      document.getElementById('next-btn').classList.remove('show');
    }

    // Handle answer selection
    function selectAnswer(selectedLetter) {
      if (hasAnswered) return;
      hasAnswered = true;

      const question = shuffledQuestions[currentQuestionIndex];
      const isCorrect = selectedLetter === question.correct;

      if (isCorrect) {
        score++;
      }

      // Award XP and get amount earned
      const xpEarned = awardXP(isCorrect);

      // Update per-topic stats
      updateTopicStats(question, isCorrect);

      // Increment total questions answered
      gamificationState.totalQuestionsAnswered++;

      // Check for achievements (milestone and mastery)
      checkAchievements();

      // Track this question result
      questionResults[question.id] = {
        answered: true,
        correct: isCorrect
      };

      // Update button states
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(button => {
        const buttonLetter = button.textContent.charAt(0);
        button.disabled = true;

        if (buttonLetter === question.correct) {
          button.classList.add('correct');
        } else if (buttonLetter === selectedLetter && !isCorrect) {
          button.classList.add('incorrect');
        }
      });

      // Show feedback
      const feedback = document.getElementById('feedback');
      const feedbackHeader = feedback.querySelector('.feedback-header');

      feedback.classList.add('show', isCorrect ? 'correct' : 'incorrect');
      feedbackHeader.classList.add(isCorrect ? 'correct' : 'incorrect');

      document.getElementById('feedback-icon').textContent = isCorrect ? '' : '';
      document.getElementById('feedback-title').textContent = isCorrect ? 'Correct!' : 'Incorrect';
      document.getElementById('feedback-explanation').textContent = question.explanation;

      // Display XP earned
      const xpDisplay = document.getElementById('xp-earned');
      if (isCorrect && xpEarned > 0) {
        let xpText = `+${xpEarned} XP`;
        if (gamificationState.currentStreak > 1) {
          xpText += ` | Streak x${gamificationState.currentStreak}!`;
        }
        xpDisplay.textContent = xpText;
        xpDisplay.style.display = 'inline-block';
      } else {
        xpDisplay.style.display = 'none';
      }

      if (!isCorrect) {
        const correctOption = question.options.find(opt => opt.charAt(0) === question.correct);
        document.getElementById('correct-answer').textContent = `Correct answer: ${correctOption}`;
      } else {
        document.getElementById('correct-answer').textContent = '';
      }

      // Show next button
      document.getElementById('next-btn').classList.add('show');

      // Save progress after answering
      saveProgress();
    }

    // Move to next question or show final score
    function nextQuestion() {
      currentQuestionIndex++;

      if (currentQuestionIndex < shuffledQuestions.length) {
        saveProgress();
        displayQuestion();
      } else {
        showFinalScore();
      }
    }

    // Display final score
    function showFinalScore() {
      document.getElementById('quiz-area').style.display = 'none';
      document.getElementById('final-score').classList.add('show');

      const totalQuestions = shuffledQuestions.length;
      const percentage = Math.round((score / totalQuestions) * 100);

      // Increment quizzes completed
      gamificationState.quizzesCompleted++;
      saveGamificationState();

      // Check for quiz-related achievements (quiz completion and perfect score)
      const isPerfect = checkPerfectScore(score, totalQuestions);
      checkAchievements({ perfectQuiz: isPerfect });

      // Save to history
      saveQuizHistory(score, totalQuestions);

      // Clear current progress (quiz is complete)
      resetProgress();

      document.getElementById('score-number').textContent = `${score}/${totalQuestions}`;
      document.getElementById('score-percentage').textContent = `${percentage}%`;

      let message = '';
      if (percentage >= 90) {
        message = 'Outstanding! You have excellent mastery of molecular genetics concepts.';
      } else if (percentage >= 80) {
        message = 'Great job! You have a strong understanding of the material.';
      } else if (percentage >= 70) {
        message = 'Good work! You understand most concepts but could benefit from more review.';
      } else if (percentage >= 60) {
        message = 'Passing grade, but there\'s room for improvement. Review the explanations and try again.';
      } else {
        message = 'Keep studying! Review the material and take the quiz again to improve your score.';
      }

      document.getElementById('score-message').textContent = message;

      // Display history
      displayQuizHistory();
    }

    // Display quiz history on final score screen
    function displayQuizHistory() {
      const history = getQuizHistory();
      const historyContainer = document.getElementById('quiz-history');

      if (!historyContainer) return;

      if (history.length === 0) {
        historyContainer.innerHTML = '';
        return;
      }

      const recentHistory = history.slice(0, 5);
      let historyHTML = '<h3 style="color: #667eea; font-size: 20px; margin: 30px 0 15px 0;">Recent History</h3>';
      historyHTML += '<div style="background: #f9fafb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">';

      recentHistory.forEach((attempt, index) => {
        const date = new Date(attempt.date);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        historyHTML += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; ${index < recentHistory.length - 1 ? 'border-bottom: 1px solid #e5e7eb;' : ''}">
            <div style="color: #6b7280; font-size: 14px;">
              ${dateStr} ${timeStr}
            </div>
            <div style="font-weight: 600; color: ${attempt.percentage >= 70 ? '#22c55e' : '#ef4444'};">
              ${attempt.score}/${attempt.total} (${attempt.percentage}%)
            </div>
          </div>
        `;
      });

      historyHTML += '</div>';
      historyContainer.innerHTML = historyHTML;
    }

    // Show resuming message
    function showResumingMessage() {
      const counter = document.getElementById('counter');
      const originalText = counter.textContent;
      counter.innerHTML = `<span style="color: #667eea; font-weight: 700;">Resuming from Question ${currentQuestionIndex + 1}</span>`;

      setTimeout(() => {
        counter.textContent = originalText;
      }, 3000);
    }

    // Reset and restart quiz
    function resetQuiz() {
      resetProgress();

      // If in topic mode, restart same topic quiz
      if (currentMode === 'topic' && currentTopic) {
        startTopicQuiz(currentTopic);
      } else if (currentMode === 'weak') {
        startWeakSpotsQuiz();
      } else {
        // Return to home screen for standard mode
        currentMode = 'standard';
        currentTopic = null;
        showHomeScreen();
      }
    }

    // Go back to home screen from quiz
    function goToHomeScreen() {
      resetProgress();
      currentMode = 'standard';
      currentTopic = null;
      showHomeScreen();
    }

    // Reset progress with confirmation
    function resetProgressWithConfirmation() {
      if (confirm('Are you sure you want to reset your progress? This will clear your current quiz session.')) {
        resetProgress();
        location.reload();
      }
    }

    // Start quiz when page loads
    window.onload = initQuiz;
  </script>
</body>
</html>
